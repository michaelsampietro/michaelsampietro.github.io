<div class="container py-5">
    <div *ngIf="!compraFinalizada" fxLayout="column" fxLayoutGap="5%">
        <p class="main-text text-dark">Endereço de entrega</p>

        <div id="endereco" class="card rounded-20 px-4 py-2" fxLayout="row wrap" fxLayoutAlign="center center">
            <div fxFlex="100" fxFlex.gt-sm="33" class="p-3">
                <p>{{user.name}}</p>
                <p class="m-0">{{user.cpf | mask:'000.000.000-00'}}</p>
                <p class="m-0">{{user.email}}</p>
                <p class="m-0">{{user.phoneAreaCode + user.phone | mask:'(00) 0000-0000'}}</p>
            </div>

            <div fxFlex="60" fxFlex.gt-sm="33" class="p-3 text-left" fxLayout="column"
                fxLayoutAlign.gt-sm="space-around center">
                <span>{{address.address}},{{address.number}}</span>
                <span>CEP {{address.cep}}</span>
                <span>{{address.city}} - {{address.state}}</span>
            </div>

            <div fxFlex="40" fxFlex.gt-sm="33" class="p-3 text-center">
                <u><a class="link" (click)="changeAddress()">Alterar dados de entrega</a></u>
            </div>
        </div>

        <p class="main-text text-dark">Meio de pagamento</p>

        <div fxLayout="row wrap" fxLayoutAlign="space-between start">

            <div fxFlex="100" fxFlex.gt-sm="30">
                <app-cart-overview [showButton]="false"></app-cart-overview>
            </div>

            <div fxFlex="100" fxFlex.gt-sm="68" id="payment-wrapper">
                <mat-tab-group #payment (selectedTabChange)="tabChanged($event)" class="w-100">
                    <mat-tab label="Cartão de crédito">
                        <div class="py-5 my-2 card rounded-20 text-center">
                            <span style="font-size: 48px; line-height: 48px; font-weight: 100;">Selecione uma das opções
                                acima</span>
                        </div>
                    </mat-tab>
                    <mat-tab label="Cartão de crédito">
                        <form [formGroup]="cardForm">
                            <div class="py-5 px-4 my-2 card rounded-20">
                                <mat-form-field appearance="none">
                                    <mat-label class="label">Número do cartão</mat-label>
                                    <input matInput type="text" (focusout)="getCardInfoAndInstallments($event.target.value)" [formControl]="number" required>
                                    <mat-error *ngIf="number.touched && number.errors">Campo obrigatório.</mat-error>
                                </mat-form-field>

                                <div fxLayout="row" fxLayoutAlign="space-between start">
                                    <div fxFlex="68">
                                        <mat-form-field appearance="none">
                                            <mat-label class="label">Nome impresso no cartão</mat-label>
                                            <input matInput type="text" [formControl]="name" required>
                                            <mat-error *ngIf="name.touched && name.errors">Campo obrigatório.</mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxFlex="14" style="position: relative;">
                                        <label class="label custom-label">Vencimento</label>
                                        <mat-form-field appearance="none">
                                            <input matInput type="text" [mask]="'00'" [formControl]="month" required placeholder="XX">
                                            <mat-error *ngIf="month.touched && month.errors">Campo obrigatório.</mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxFlex="14">

                                        <mat-form-field appearance="none">
                                            <input matInput type="text" [mask]="'0000'" [formControl]="year" placeholder="XXXX" required>
                                            <mat-error *ngIf="year.touched && year.errors">Campo obrigatório.</mat-error>
                                        </mat-form-field>
                                    </div>
                                </div>

                                <div fxLayout="row" fxLayoutAlign="space-between center">
                                    <div fxFlex="20">
                                        <mat-form-field appearance="none">
                                            <mat-label class="label">Cód. de segurança</mat-label>
                                            <input matInput type="text" [mask]="'0009'" [formControl]="security" required>
                                            <mat-error *ngIf="security.touched && security.errors">Campo obrigatório.</mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div fxFlex="70">
                                        <mat-form-field class="w-100">
                                            <mat-label>Opções de parcelamento</mat-label>
                                            <mat-select (selectionChange)="setInstallment($event)" class="label" [disabled]="installments.length === 0">
                                                <mat-option *ngFor="let installment of installments" [value]="installment">
                                                    {{installment.quantity}} x <span *ngIf="installment.interestFree">sem juros</span> de {{installment.installmentAmount | currency:'BRL'}}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>
                                </div>

                                <mat-checkbox (change)="toggleAddressForm($event)" formControlName="sameAddress">O endereço de cobrança é o mesmo do endereço de entrega.</mat-checkbox>

                                <div fxLayout="column" *ngIf="showAddressForm">
                                    <mat-form-field appearance="none">
                                        <mat-label class="label">CEP</mat-label>
                                        <input matInput (keyup)="checkCEP(postalcode.value)" type="text" [mask]="'00000-000'" [formControl]="postalcode" required>
                                        <u class="text-right d-block text-dark">
                                            <a href="http://www.buscacep.correios.com.br/sistemas/buscacep/" target="_blank">Não sei meu CEP</a>                
                                        </u>
                                        <mat-error *ngIf="postalcode.touched && postalcode.errors">Campo obrigatório.</mat-error>
                                    </mat-form-field>
                            
                                    <mat-form-field appearance="none">
                                        <mat-label class="label">Endereço</mat-label>
                                        <input matInput readonly type="text" [formControl]="street" [value]="street.value" required>
                                        <mat-error *ngIf="street.touched && street.errors">Campo obrigatório.</mat-error>
                                    </mat-form-field>
                                    
                                    <div class="w-100" fxLayout="row" fxLayoutAlign="space-between center">
                                        <div fxFlex="48">
                                            <mat-form-field appearance="none">
                                                <mat-label class="label">Número</mat-label>
                                                <input matInput type="text" [formControl]="addressNumber" required>
                                                <mat-error *ngIf="addressNumber.touched && addressNumber.errors">Campo obrigatório.</mat-error>
                                            </mat-form-field>
                                        </div>
                            
                                        <div fxFlex="48">
                                            <mat-form-field appearance="none">
                                                <mat-label class="label">Complemento</mat-label>
                                                <input matInput type="text" [formControl]="complement" placeholder="Ex: Ap. XX, Casa X">
                                            </mat-form-field>
                                        </div>
                                    </div>
                            
                                    <mat-form-field appearance="none">
                                        <mat-label class="label">Bairro</mat-label>
                                        <input matInput readonly type="text" [formControl]="district" required>
                                        <mat-error *ngIf="district.touched && district.errors">Campo obrigatório.</mat-error>
                                    </mat-form-field>
                            
                                    <div class="w-100" fxLayout="row" fxLayoutAlign="space-between center">
                                        <div fxFlex="68">
                                            <mat-form-field appearance="none">
                                                <mat-label class="label">Cidade</mat-label>
                                                <input matInput type="text" [formControl]="city" required readonly>
                                                <mat-error *ngIf="city.touched && city.errors">Campo obrigatório.</mat-error>
                                            </mat-form-field>
                                        </div>
                            
                                        <div fxFlex="28">
                                            <mat-form-field appearance="none">
                                                <mat-label class="label">Estado</mat-label>
                                                <input matInput type="text" [formControl]="state" required readonly>
                                                <mat-error *ngIf="state.touched && state.errors">Campo obrigatório.</mat-error>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button [disabled]="cardForm.invalid" mat-flat-button class="btn bg-highlight btn-rounded m-auto float-right my-3" type="submit" (click)="card(cardForm.value)">Finalizar compra</button>
                        </form>
                    </mat-tab>
                    <mat-tab label="Boleto bancário">
                        <div class="py-5 my-2 card rounded-20 text-center">
                            <div>
                                <p class="font-weight-bold">Atenção: O pagamento através de boleto acrescentará 3 dias úteis no prazo de entrega
                                    devido a compensação bancária.</p>
                                <p>Após clicar em "Finalizar compra" você receberá o seu boleto bancário. É possível
                                    imprimi-lo e pagar pelo site do seu banco ou em uma casa lotérica. Nota: O pedido
                                    será confirmado apenas após a confirmação do pagamento</p>
                            </div>
                        </div>
                        <button mat-flat-button class="btn bg-highlight btn-rounded m-auto float-right my-3" (click)="boleto()">Finalizar compra</button>
                    </mat-tab>
                </mat-tab-group>
            </div>
        </div>
    </div>

    <div *ngIf="compraFinalizada">
        <h1>Sucesso!</h1>
    </div>
</div>

